<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            text-align: center; 
            padding: 20px; 
            margin: 0;
            user-select: none;
        }
        #coins { font-size: 48px; margin: 20px; font-weight: bold; }
        #dice { 
            font-size: 120px; 
            margin: 20px; 
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        #dice.anim { animation: diceRoll 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(360deg) scale(1.4); }
            50% { transform: rotate(720deg) scale(1.7); }
            75% { transform: rotate(1080deg) scale(1.4); }
            100% { transform: rotate(1440deg) scale(1); }
        }
        button { 
            background: linear-gradient(45deg, #00ff88, #00cc66); 
            border: none; 
            padding: 15px 30px; 
            font-size: 20px; 
            border-radius: 15px; 
            margin: 8px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,255,136,0.4);
            transition: all 0.2s;
        }
        button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,255,136,0.6); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        #board { 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            max-width: 900px; 
            margin: 30px auto; 
            gap: 6px;
        }
        .slot { 
            width: 68px; 
            height: 68px; 
            border-radius: 14px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .slot:hover { transform: scale(1.12); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
        .current { 
            background: linear-gradient(45deg, #ffd700, #ffaa00) !important; 
            border: 4px solid #ff6600 !important; 
            box-shadow: 0 0 25px #ffaa00 !important; 
            transform: scale(1.15) !important;
        }
        .highlight { 
            background: linear-gradient(45deg, #ffd700, #ff6600) !important; 
            box-shadow: 0 0 50px #ffd700, 0 0 70px #ff6600 !important; 
            transform: scale(1.4) !important; 
            animation: pulse 0.6s infinite !important;
        }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.75;} }
        .locked { background: #666 !important; color: #ddd; }
        .prestigeBtn { background: #ffcc00; color: #333; font-size: 22px; }
    </style>
</head>
<body>
    <h1>üçÄ –ë—Ä–æ—Å–∫–∏ –ö—É–±–∏–∫–æ–≤ üçÄ</h1>
    <div id="coins">–ú–æ–Ω–µ—Ç—ã: 0</div>
    <div id="dice">üé≤</div>
    <button id="rollBtn">–ö—Ä—É—Ç–∏—Ç—å! (5/5)</button>
    <button id="adBtn">üì∫ –†–µ–∫–ª–∞–º–∞ –∑–∞ +3</button>
    <button id="dailyBtn">üéÅ –ï–∂–µ–¥–Ω–µ–≤–∫–∞</button>
    <button id="leaderboardBtn">üèÜ –¢–æ–ø-10</button>
    <button id="prestigeBtn" class="prestigeBtn" disabled>üîÑ Prestige</button>
    <div id="board"></div>
    <button id="shareBtn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>

    <script>
        const boardSize = 20;
        const REGEN_TIME = 600000; // 10 –º–∏–Ω
        const DAY_MS = 86400000;
        const PITY_ROLLS = 20; // –ì–∞—Ä–∞–Ω—Ç –¥–∂–µ–∫–ø–æ—Ç–∞

        let coins = 0, energy = 0, lastEnergyUpdate = Date.now(), rollsLeft = 0;
        let multipliers = Array(boardSize).fill(1);
        let unlocked = Array(boardSize).fill(false);
        let currentPosition = 0;
        let lastDailyClaim = 0;
        let globalMulti = 1.0; // Prestige –±—É—Å—Ç
        let rollsSinceJackpot = 0;
        let prestigeLevel = 0;

        const tg = window.Telegram.WebApp;
        tg.initDataUnsafe = tg.initDataUnsafe || {};
        tg.ready();
        tg.expand();

        function loadProgress() {
            const saved = localStorage.getItem('diceProgress');
            if (saved) {
                const data = JSON.parse(saved);
                coins = data.coins || 0;
                multipliers = data.multipliers || Array(boardSize).fill(1);
                unlocked = data.unlocked || Array(boardSize).fill(false);
                currentPosition = data.currentPosition || 0;
                energy = data.energy || 0;
                lastEnergyUpdate = data.lastEnergyUpdate || Date.now();
                lastDailyClaim = data.lastDailyClaim || 0;
                globalMulti = data.globalMulti || 1.0;
                prestigeLevel = data.prestigeLevel || 0;
                rollsSinceJackpot = data.rollsSinceJackpot || 0;
            }
            if (!unlocked[0]) unlocked.slice(0,3).forEach((_,i) => unlocked[i]=true);
            updateEnergy();
            updateUI();
        }

        function saveProgress() {
            const data = {
                coins, multipliers, unlocked, currentPosition,
                energy, lastEnergyUpdate, lastDailyClaim,
                globalMulti, prestigeLevel, rollsSinceJackpot,
                updatedAt: Date.now()
            };
            localStorage.setItem('diceProgress', JSON.stringify(data));
        }

        setInterval(() => {
            updateEnergy();
            updateUI();
        }, 60000);

        function updateEnergy() {
            const now = Date.now();
            const elapsed = Math.floor((now - lastEnergyUpdate) / REGEN_TIME);
            if (elapsed > 0) {
                energy = Math.min(5, energy + elapsed);
                lastEnergyUpdate += elapsed * REGEN_TIME;
            }
            rollsLeft = energy;
        }

        function updateUI() {
            document.getElementById('coins').textContent = `–ú–æ–Ω–µ—Ç—ã: ${Math.floor(coins).toLocaleString()}`;
            const rollBtn = document.getElementById('rollBtn');
            rollBtn.textContent = `–ö—Ä—É—Ç–∏—Ç—å! (${rollsLeft}/5)`;
            rollBtn.disabled = rollsLeft <= 0;
            document.getElementById('prestigeBtn').disabled = !unlocked.every(u => u);
            updateBoard();
        }

        function updateBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (let i = 0; i < boardSize; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                if (i === currentPosition) slot.classList.add('current');
                if (!unlocked[i]) {
                    const cost = unlockCost(i);
                    slot.innerHTML = `?<br>${cost.toLocaleString()}`;
                    slot.classList.add('locked');
                } else {
                    slot.innerHTML = `x${(multipliers[i] * globalMulti).toFixed(1)}`;
                }
                slot.onclick = () => handleSlot(i);
                boardEl.appendChild(slot);
            }
        }

        function unlockCost(i) { return Math.floor(500 * Math.pow(1.5, i) * Math.pow(2, prestigeLevel)); }
        function upgradeCost(i) { return Math.floor(800 * multipliers[i] * Math.pow(2, prestigeLevel)); }

        function handleSlot(i) {
            tg.HapticFeedback.impactOccurred('medium');
            if (!unlocked[i]) {
                const cost = unlockCost(i);
                if (coins >= cost) {
                    coins -= cost;
                    unlocked[i] = true;
                    tg.showAlert('–°–ª–æ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! üöÄ');
                } else {
                    tg.showAlert(`–ù—É–∂–Ω—ã ${cost.toLocaleString()} –º–æ–Ω–µ—Ç ‚òùÔ∏è`);
                }
            } else {
                const cost = upgradeCost(i);
                if (coins >= cost) {
                    coins -= cost;
                    multipliers[i] *= 1.5;
                    tg.showAlert(`x${(multipliers[i] * globalMulti).toFixed(1)}! üí•`);
                } else {
                    tg.showAlert(`–ù—É–∂–Ω—ã ${cost.toLocaleString()} –º–æ–Ω–µ—Ç ‚òùÔ∏è`);
                }
            }
            updateUI();
            saveProgress();
        }

        function roll() {
            if (rollsLeft <= 0) return;
            tg.HapticFeedback.impactOccurred('heavy');
            const diceEl = document.getElementById('dice');
            diceEl.classList.add('anim');
            setTimeout(() => {
                diceEl.classList.remove('anim');
                const steps = Math.floor(Math.random() * 6) + 1;
                let reward = 0;
                let path = [];
                let tempPos = currentPosition;
                let hasJackpot = false;
                rollsSinceJackpot++;
                for (let i = 0; i < steps; i++) {
                    tempPos = (tempPos + 1) % boardSize;
                    path.push(tempPos);
                    if (unlocked[tempPos]) {
                        let slotR = multipliers[tempPos] * globalMulti;
                        let bonus = getBonus(); // Weighted
                        if (bonus === 'x2') slotR *= 2;
                        if (bonus === 'jackpot' || rollsSinceJackpot >= PITY_ROLLS) {
                            slotR *= 10;
                            hasJackpot = true;
                            rollsSinceJackpot = 0;
                        }
                        reward += slotR;
                    }
                }
                coins += reward;
                currentPosition = tempPos;
                animatePath(path);
                tg.showAlert(`${hasJackpot ? 'üí• –ö–†–ò–¢–ò–ß–ù–´–ô!' : 'üéâ'} ${steps} —à–∞–≥–æ–≤! +${Math.floor(reward)} –º–æ–Ω–µ—Ç!`);
                energy--;
                lastEnergyUpdate = Date.now();
                updateEnergy();
                updateUI();
                saveProgress();
            }, 1300);
        }

        function getBonus() {
            const rand = Math.random();
            if (rand < 0.7) return 'none';
            if (rand < 0.9) return 'x2';
            return 'jackpot';
        }

        function animatePath(path) {
            path.forEach((pos, idx) => {
                setTimeout(() => {
                    document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
                    const slot = document.querySelector(`[data-index="${pos}"]`);
                    if (slot) {
                        slot.classList.add('highlight');
                        tg.HapticFeedback.impactOccurred('light');
                    }
                }, idx * 280);
            });
            setTimeout(() => document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')), path.length * 280 + 600);
        }

        function claimDaily() {
            const now = Date.now();
            const today = Math.floor(now / DAY_MS);
            if (today > lastDailyClaim) {
                coins += 500 * globalMulti;
                lastDailyClaim = today;
                tg.showAlert('üåü +' + Math.floor(500 * globalMulti) + ' –º–æ–Ω–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ!');
                updateUI();
                saveProgress();
            } else {
                tg.showAlert('–£–∂–µ –≤–∑—è—Ç–æ —Å–µ–≥–æ–¥–Ω—è! –ó–∞–≤—Ç—Ä–∞ –µ—â—ë üëÄ');
            }
        }

        function showLeaderboard() {
            tg.showAlert('üèÜ –¢—ã #1 —Å ' + Math.floor(coins).toLocaleString() + ' –º–æ–Ω–µ—Ç–∞–º–∏! (–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø) üëë');
        }

        function watchAd() {
            energy = Math.min(5, energy + 3);
            updateEnergy();
            tg.showAlert('üì∫ +3 –∫—Ä—É—Ç–∫–∏! –ì–æ—Ç–æ–≤–æ üöÄ');
            updateUI();
        }

        function prestige() {
            if (!unlocked.every(u => u)) return;
            prestigeLevel++;
            globalMulti += 0.1;
            unlocked = Array(boardSize).fill(false);
            unlocked.slice(0,3).forEach((_,i) => unlocked[i]=true);
            multipliers = Array(boardSize).fill(1);
            currentPosition = 0;
            coins = 0; // –ò–ª–∏ +bonus
            tg.showAlert(`üîÑ Prestige ${prestigeLevel}! +10% –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä! üåü`);
            updateUI();
            saveProgress();
        }

        function share() {
            tg.shareUrl(
                tg.initDataUnsafe.start_app || window.location.href,
                `üçÄ ${Math.floor(coins).toLocaleString()} –º–æ–Ω–µ—Ç –≤ –ë—Ä–æ—Å–∫–∞—Ö! –ò–≥—Ä–∞–π:`
            );
            coins += 200 * globalMulti;
            tg.showAlert('üì§ +' + Math.floor(200 * globalMulti) + ' –º–æ–Ω–µ—Ç –∑–∞ —à–∞—Ä–∏–Ω–≥! üî•');
            updateUI();
            saveProgress();
        }

        document.getElementById('rollBtn').onclick = roll;
        document.getElementById('adBtn').onclick = watchAd;
        document.getElementById('dailyBtn').onclick = claimDaily;
        document.getElementById('leaderboardBtn').onclick = showLeaderboard;
        document.getElementById('prestigeBtn').onclick = prestige;
        document.getElementById('shareBtn').onclick = share;
        document.getElementById('dice').onclick = roll;

        loadProgress();
    </script>
</body>
</html>