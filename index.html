<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* iOS-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            position: fixed; /* –§–∏–∫—Å–∏—Ä—É–µ–º —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ iOS */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            user-select: none;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        #settingsBtn {
            position: absolute;
            top: max(10px, env(safe-area-inset-top));
            right: max(10px, env(safe-area-inset-right));
            background: transparent;
            border: none;
            font-size: 24px;
            z-index: 100;
            padding: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        header {
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        #coins {
            font-size: clamp(28px, 8vw, 48px);
            font-weight: bold;
            margin: 10px 0;
            word-break: break-word;
        }

        #dice {
            font-size: clamp(60px, 20vw, 120px);
            transition: transform 0.3s ease;
            cursor: pointer;
            margin: 10px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #dice.anim {
            animation: diceRoll 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(360deg) scale(1.4); }
            50% { transform: rotate(720deg) scale(1.7); }
            75% { transform: rotate(1080deg) scale(1.4); }
            100% { transform: rotate(1440deg) scale(1); }
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            width: 100%;
            overflow: hidden;
        }

        .board-container {
            width: 100%;
            overflow-x: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .board-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        #board {
            display: flex;
            justify-content: flex-start;
            flex-wrap: nowrap;
            gap: 8px;
            padding: 0 16px;
            min-width: min-content;
        }

        .slot {
            min-width: 60px;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: white;
            flex-shrink: 0;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .slot:active {
            transform: scale(0.95);
        }

        .slot:hover {
            transform: scale(1.12);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .current {
            background: linear-gradient(45deg, #ffd700, #ffaa00) !important;
            border: 3px solid #ff6600 !important;
            box-shadow: 0 0 20px #ffaa00, 0 0 10px #ffd700 inset !important;
            transform: scale(1.1) !important;
        }

        .highlight {
            background: linear-gradient(45deg, #ffd700, #ff6600) !important;
            box-shadow: 0 0 30px #ffd700, 0 0 50px #ff6600 !important;
            transform: scale(1.3) !important;
            animation: pulse 0.6s infinite !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.75; }
        }

        .locked {
            background: #444 !important;
            color: #eee;
        }

        .unlocked {
            background: linear-gradient(45deg, #00ff88, #00cc66);
        }

        #progress-bar {
            width: 90%;
            max-width: 400px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 15px auto;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: #ffd700;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        footer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            width: 100%;
            margin-top: auto;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }

        button {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 110px;
            flex: 1;
            min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è iOS */
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.95);
        }

        button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.6);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .prestigeBtn {
            background: linear-gradient(45deg, #ffcc00, #ff9900);
            color: #333;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .modal-content {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 16px;
            text-align: left;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 20px;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: #333;
        }

        .modal-content p {
            margin: 10px 0;
            line-height: 1.4;
        }

        .modal-content button {
            margin-top: 15px;
            width: 100%;
        }

        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            .slot {
                min-width: 55px;
                width: 55px;
                height: 55px;
                font-size: 10px;
            }

            button {
                min-width: 100px;
                font-size: 13px;
                padding: 10px 12px;
            }

            #dice {
                font-size: clamp(50px, 18vw, 90px);
            }

            footer {
                gap: 6px;
                padding: 10px;
            }

            .modal-content {
                padding: 16px;
                max-width: 95%;
            }
        }

        @media (max-width: 320px) {
            .slot {
                min-width: 50px;
                width: 50px;
                height: 50px;
                font-size: 9px;
            }

            button {
                min-width: 90px;
                font-size: 12px;
            }
        }

        /* –ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
        @media (orientation: portrait) and (max-height: 700px) {
            header {
                padding: 10px;
                padding-top: max(10px, env(safe-area-inset-top));
            }
            
            #dice {
                font-size: clamp(50px, 15vw, 80px);
                min-height: 80px;
            }
            
            .board-container {
                max-height: 100px;
            }
        }

        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                flex-direction: row;
                overflow-y: auto;
            }
            
            .main {
                flex: 3;
            }
            
            footer {
                flex-direction: column;
                width: auto;
                flex: 1;
                max-width: 200px;
            }
            
            #board {
                flex-wrap: wrap;
                max-height: 150px;
                overflow-y: auto;
            }
            
            .slot {
                min-width: 50px;
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>

<body>
    <button id="settingsBtn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>

    <div id="tutorial-modal" class="modal">
        <div class="modal-content">
            <h2>üéÆ –ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</h2>
            <p>1. –ù–∞–∂–º–∏ –Ω–∞ –∫—É–±–∏–∫, —á—Ç–æ–±—ã –±—Ä–æ—Å–∏—Ç—å –µ–≥–æ –∏ –ø—Ä–æ–π—Ç–∏ –ø–æ –ø–æ–ª—é</p>
            <p>2. –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–ª–æ—Ç–∞—Ö</p>
            <p>3. –û—Ç–∫—Ä—ã–≤–∞–π –∏ —É–ª—É—á—à–∞–π —Å–ª–æ—Ç—ã –∑–∞ –º–æ–Ω–µ—Ç—ã</p>
            <p>4. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤</p>
            <button onclick="closeModal('tutorial-modal')">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <button onclick="coins += 1000000; updateUI(); saveProgress(); showAlert('+1M –º–æ–Ω–µ—Ç');" style="background: #ff0066; color: white; margin-bottom: 10px;">
                +1M –º–æ–Ω–µ—Ç
            </button>
            <button onclick="energy = 5; updateUI(); saveProgress(); showAlert('–≠–Ω–µ—Ä–≥–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');" style="margin-bottom: 10px;">
                ‚ôªÔ∏è –ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è
            </button>
            <button onclick="closeModal('settings-modal')">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <div id="confetti"></div>

    <header>
        <h1 style="font-size: clamp(20px, 6vw, 28px); margin: 0 0 10px 0;">üçÄ –ë—Ä–æ—Å–∫–∏ –ö—É–±–∏–∫–æ–≤ üçÄ</h1>
        <div id="coins">–ú–æ–Ω–µ—Ç—ã: 0</div>
    </header>

    <div class="main">
        <div id="dice" role="button" tabindex="0" aria-label="–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫">üé≤</div>
        <div id="progress-bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å —ç–Ω–µ—Ä–≥–∏–∏">
            <div id="progress-fill" style="width: 0%"></div>
        </div>

        <div class="board-container">
            <div id="board" role="region" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></div>
        </div>
    </div>

    <footer>
        <button id="rollBtn">üé≤ –ö—Ä—É—Ç–∏—Ç—å! (0/5)</button>
        <button id="adBtn">üì∫ +3 –±—Ä–æ—Å–∫–∞</button>
        <button id="dailyBtn">üéÅ –ï–∂–µ–¥–Ω–µ–≤–∫–∞</button>
        <button id="prestigeBtn" class="prestigeBtn">üîÑ Prestige</button>
        <button id="helpBtn">‚ùì –ü–æ–º–æ—â—å</button>
    </footer>

    <script>
        const boardSize = 20;
        const REGEN_TIME = 600000;
        const DAY_MS = 86400000;
        const PITY_ROLLS = 20;

        let coins = 0, energy = 0, lastEnergyUpdate = Date.now(), rollsLeft = 0;
        let multipliers = Array(boardSize).fill(1);
        let unlocked = Array(boardSize).fill(false);
        let currentPosition = 0;
        let lastDailyClaim = 0;
        let globalMulti = 1.0;
        let rollsSinceJackpot = 0;
        let prestigeLevel = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (tg) {
            tg.ready();
            tg.expand();
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è iOS
            tg.enableClosingConfirmation();
        }

        function loadProgress() {
            const saved = localStorage.getItem('diceProgress');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    coins = data.coins || 0;
                    multipliers = data.multipliers || Array(boardSize).fill(1);
                    unlocked = data.unlocked || Array(boardSize).fill(false);
                    currentPosition = data.currentPosition || 0;
                    energy = data.energy || 0;
                    lastEnergyUpdate = data.lastEnergyUpdate || Date.now();
                    lastDailyClaim = data.lastDailyClaim || 0;
                    globalMulti = data.globalMulti || 1.0;
                    prestigeLevel = data.prestigeLevel || 0;
                    rollsSinceJackpot = data.rollsSinceJackpot || 0;
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                }
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Å–ª–æ—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            if (!unlocked.some(u => u)) {
                unlocked[0] = true;
                unlocked[1] = true;
                unlocked[2] = true;
            }

            updateEnergy();
            updateUI();
        }

        function saveProgress() {
            const data = {
                coins, multipliers, unlocked, currentPosition,
                energy, lastEnergyUpdate, lastDailyClaim,
                globalMulti, prestigeLevel, rollsSinceJackpot,
                updatedAt: Date.now()
            };
            localStorage.setItem('diceProgress', JSON.stringify(data));
        }

        function updateEnergy() {
            const now = Date.now();
            const elapsed = Math.floor((now - lastEnergyUpdate) / REGEN_TIME);
            if (elapsed > 0) {
                energy = Math.min(5, energy + elapsed);
                lastEnergyUpdate += elapsed * REGEN_TIME;
                saveProgress();
            }
            rollsLeft = energy;
        }

        function updateUI() {
            document.getElementById('coins').textContent = `–ú–æ–Ω–µ—Ç—ã: ${Math.floor(coins).toLocaleString()}`;
            const rollBtn = document.getElementById('rollBtn');
            rollBtn.textContent = `üé≤ –ö—Ä—É—Ç–∏—Ç—å! (${rollsLeft}/5)`;
            rollBtn.disabled = rollsLeft <= 0;

            const prestigeBtn = document.getElementById('prestigeBtn');
            prestigeBtn.disabled = !unlocked.every(u => u);
            prestigeBtn.textContent = `üîÑ Prestige ${prestigeLevel}`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            const progressPercent = (energy / 5) * 100;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;

            updateBoard();
        }

        function updateBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';

            for (let i = 0; i < boardSize; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                slot.setAttribute('role', 'button');
                slot.setAttribute('tabindex', '0');
                slot.setAttribute('aria-label', `–°–ª–æ—Ç ${i + 1}`);

                if (i === currentPosition) {
                    slot.classList.add('current');
                    slot.setAttribute('aria-current', 'true');
                }

                if (!unlocked[i]) {
                    const cost = unlockCost(i);
                    slot.innerHTML = `üîí<br>${cost.toLocaleString()}`;
                    slot.classList.add('locked');
                    slot.setAttribute('aria-label', `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ—Ç ${i + 1}, —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${cost.toLocaleString()} –º–æ–Ω–µ—Ç`);
                } else {
                    slot.innerHTML = `x${(multipliers[i] * globalMulti).toFixed(1)}`;
                    slot.classList.add('unlocked');
                    slot.setAttribute('aria-label', `–°–ª–æ—Ç ${i + 1}, –º–Ω–æ–∂–∏—Ç–µ–ª—å: x${(multipliers[i] * globalMulti).toFixed(1)}`);
                }

                slot.onclick = (e) => {
                    e.preventDefault();
                    handleSlot(i);
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
                slot.ontouchstart = (e) => {
                    e.preventDefault();
                };
                
                boardEl.appendChild(slot);
            }

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
            setTimeout(() => {
                const currentSlot = document.querySelector(`[data-index="${currentPosition}"]`);
                if (currentSlot) {
                    currentSlot.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center', 
                        inline: 'center'
                    });
                }
            }, 100);
        }

        function unlockCost(i) {
            return Math.floor(500 * Math.pow(1.5, i) * Math.pow(2, prestigeLevel));
        }

        function upgradeCost(i) {
            return Math.floor(800 * multipliers[i] * Math.pow(2, prestigeLevel));
        }

        function handleSlot(i) {
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            if (!unlocked[i]) {
                const cost = unlockCost(i);
                if (coins >= cost) {
                    coins -= cost;
                    unlocked[i] = true;
                    showAlert('–°–ª–æ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω! üöÄ');
                } else {
                    showAlert(`–ù—É–∂–Ω—ã ${cost.toLocaleString()} –º–æ–Ω–µ—Ç ‚òùÔ∏è`);
                }
            } else {
                const cost = upgradeCost(i);
                if (coins >= cost) {
                    coins -= cost;
                    multipliers[i] *= 1.5;
                    showAlert(`–£–ª—É—á—à–µ–Ω–æ –¥–æ x${(multipliers[i] * globalMulti).toFixed(1)}! üí•`);
                } else {
                    showAlert(`–ù—É–∂–Ω—ã ${cost.toLocaleString()} –º–æ–Ω–µ—Ç ‚òùÔ∏è`);
                }
            }
            updateUI();
            saveProgress();
        }

        function roll() {
            if (rollsLeft <= 0) return;

            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }

            const diceEl = document.getElementById('dice');
            diceEl.classList.add('anim');

            setTimeout(() => {
                diceEl.classList.remove('anim');
                const steps = Math.floor(Math.random() * 6) + 1;
                let reward = 0;
                let path = [];
                let tempPos = currentPosition;
                let hasJackpot = false;

                rollsSinceJackpot++;

                for (let i = 0; i < steps; i++) {
                    tempPos = (tempPos + 1) % boardSize;
                    path.push(tempPos);

                    if (unlocked[tempPos]) {
                        let slotR = multipliers[tempPos] * globalMulti;
                        let bonus = getBonus();

                        if (bonus === 'x2') slotR *= 2;
                        if (bonus === 'jackpot' || rollsSinceJackpot >= PITY_ROLLS) {
                            slotR *= 10;
                            hasJackpot = true;
                            rollsSinceJackpot = 0;
                            showConfetti();
                        }

                        reward += slotR;
                    }
                }

                coins += reward;
                currentPosition = tempPos;
                animatePath(path);

                showAlert(`${hasJackpot ? 'üí• –ö–†–ò–¢–ò–ß–ù–´–ô –£–î–ê–†!' : 'üéâ'} ${steps} —à–∞–≥–æ–≤! +${Math.floor(reward)} –º–æ–Ω–µ—Ç!`);

                energy--;
                lastEnergyUpdate = Date.now();
                updateEnergy();
                updateUI();
                saveProgress();

            }, 1300);
        }

        function getBonus() {
            const rand = Math.random();
            if (rand < 0.7) return 'none';
            if (rand < 0.9) return 'x2';
            return 'jackpot';
        }

        function animatePath(path) {
            path.forEach((pos, idx) => {
                setTimeout(() => {
                    document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
                    const slot = document.querySelector(`[data-index="${pos}"]`);
                    if (slot) {
                        slot.classList.add('highlight');
                        if (tg && tg.HapticFeedback) {
                            tg.HapticFeedback.impactOccurred('light');
                        }
                    }
                }, idx * 280);
            });

            setTimeout(() => {
                document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            }, path.length * 280 + 600);
        }

        function claimDaily() {
            const now = Date.now();
            const today = Math.floor(now / DAY_MS);

            if (today > lastDailyClaim) {
                coins += 500 * globalMulti;
                lastDailyClaim = today;
                showAlert('üåü +' + Math.floor(500 * globalMulti) + ' –º–æ–Ω–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ!');
                updateUI();
                saveProgress();
            } else {
                showAlert('–£–∂–µ –≤–∑—è—Ç–æ —Å–µ–≥–æ–¥–Ω—è! –ó–∞–≤—Ç—Ä–∞ –µ—â—ë üëÄ');
            }
        }

        function watchAd() {
            energy = Math.min(5, energy + 3);
            updateEnergy();
            showAlert('üì∫ +3 –∫—Ä—É—Ç–∫–∏! –ì–æ—Ç–æ–≤–æ üöÄ');
            updateUI();
            saveProgress();
        }

        function prestige() {
            if (!unlocked.every(u => u)) return;

            prestigeLevel++;
            globalMulti += 0.1;
            unlocked = Array(boardSize).fill(false);
            unlocked[0] = true;
            unlocked[1] = true;
            unlocked[2] = true;
            multipliers = Array(boardSize).fill(1);
            currentPosition = 0;
            coins = 0;

            showAlert(`üîÑ Prestige ${prestigeLevel}! +10% –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä! üåü`);
            updateUI();
            saveProgress();
        }

        function showHelp() {
            openModal('tutorial-modal');
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(message) {
            if (tg && tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }

        function showConfetti() {
            const confettiEl = document.getElementById('confetti');
            confettiEl.style.display = 'block';

            confettiEl.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.style.position = 'absolute';
                dot.style.width = '10px';
                dot.style.height = '10px';
                dot.style.background = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'][Math.floor(Math.random() * 5)];
                dot.style.borderRadius = '50%';
                dot.style.left = Math.random() * 100 + 'vw';
                dot.style.top = '-20px';
                dot.style.animation = `fall ${1 + Math.random() * 2}s linear forwards`;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fall {
                        to { transform: translateY(100vh) rotate(${Math.random() * 360}deg); opacity: 0; }
                    }
                `;
                confettiEl.appendChild(style);
                confettiEl.appendChild(dot);
            }

            setTimeout(() => {
                confettiEl.style.display = 'none';
                confettiEl.innerHTML = '';
            }, 2000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.getElementById('rollBtn').onclick = roll;
            document.getElementById('adBtn').onclick = watchAd;
            document.getElementById('dailyBtn').onclick = claimDaily;
            document.getElementById('prestigeBtn').onclick = prestige;
            document.getElementById('helpBtn').onclick = showHelp;
            document.getElementById('dice').onclick = roll;
            document.getElementById('settingsBtn').onclick = () => openModal('settings-modal');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –∫—É–±–∏–∫–µ
            document.getElementById('dice').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    roll();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.querySelectorAll('.modal').forEach(modal => {
                modal.onclick = function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                };
            });

            loadProgress();

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
            setInterval(() => {
                updateEnergy();
                updateUI();
            }, 60000);
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ iOS –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ iOS
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
        });

        // –î–µ–±–∞–≥ —Ñ—É–Ω–∫—Ü–∏—è
        window.debugAddCoins = function(amount = 1000000) {
            coins += amount;
            showAlert(`[DEBUG] +${amount.toLocaleString()} –º–æ–Ω–µ—Ç`);
            updateUI();
            saveProgress();
        };
    </script>
</body>

</html>